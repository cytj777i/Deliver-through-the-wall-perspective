-- Roblox手机端极速传送脚本 (UI优化版)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local Camera = workspace.CurrentCamera

-- 获取本地玩家
local LocalPlayer = Players.LocalPlayer

-- 初始化传送模块
local Teleport = {
    Active = false,
    Connection = nil,
    Target = nil,
    Wallhack = false,
    WallVision = false,
    OriginalTransparency = {},
    PlayerList = {},
    Origin = nil
}

-- UI配置 - 优化手机端体验
local UI = {
    ButtonSize = UDim2.new(0.8, 0, 0.12, 0), -- 更大的按钮尺寸
    Spacing = 0.02, -- 间距
    Position = UDim2.new(0.7, 0, 0.2, 0),
    DragHandleHeight = 0.1,
    ContainerHeight = 0.65,
    ContainerWidth = 0.3,
    FontSize = 16 -- 更大的字体
}

-- 创建按钮（优化点击体验）
local function CreateButton(name, parent, position, backgroundColor)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Size = UI.ButtonSize
    button.Position = position
    button.BackgroundColor3 = backgroundColor
    button.TextColor3 = Color3.new(1, 1, 1)
    button.Text = name
    button.TextSize = UI.FontSize
    button.TextWrapped = true
    button.Parent = parent
    
    -- 添加圆角
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = button
    
    return button
end

-- 创建UI界面
local function CreateUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "TeleportGui"
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ResetOnSpawn = false

    -- 主容器
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(UI.ContainerWidth, 0, UI.ContainerHeight, 0)
    MainFrame.Position = UI.Position
    MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    MainFrame.BackgroundTransparency = 0.2
    MainFrame.BorderSizePixel = 0
    MainFrame.ClipsDescendants = true
    MainFrame.Parent = ScreenGui

    -- 添加圆角
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = MainFrame

    -- 拖拽区域
    local DragHandle = Instance.new("TextButton")
    DragHandle.Name = "DragHandle"
    DragHandle.Size = UDim2.new(1, 0, UI.DragHandleHeight, 0)
    DragHandle.Position = UDim2.new(0, 0, 0, 0)
    DragHandle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    DragHandle.BackgroundTransparency = 0.3
    DragHandle.BorderSizePixel = 0
    DragHandle.Text = "传送控制面板 (拖拽移动)"
    DragHandle.TextColor3 = Color3.fromRGB(255, 255, 255)
    DragHandle.TextSize = UI.FontSize
    DragHandle.TextWrapped = true
    DragHandle.Parent = MainFrame

    -- 按钮容器
    local ButtonContainer = Instance.new("Frame")
    ButtonContainer.Name = "ButtonContainer"
    ButtonContainer.Size = UDim2.new(1, 0, 1 - UI.DragHandleHeight, 0)
    ButtonContainer.Position = UDim2.new(0, 0, UI.DragHandleHeight, 0)
    ButtonContainer.BackgroundTransparency = 1
    ButtonContainer.Parent = MainFrame

    -- 按钮布局计算
    local function GetButtonPosition(index)
        local yPosition = 0.02 + (UI.ButtonSize.Y.Scale + UI.Spacing) * (index - 1)
        return UDim2.new(0.1, 0, yPosition, 0)
    end

    -- 开始传送按钮
    local StartButton = CreateButton("开始传送", ButtonContainer, GetButtonPosition(1), Color3.fromRGB(50, 150, 50))
    
    -- 停止传送按钮
    local StopButton = CreateButton("停止传送", ButtonContainer, GetButtonPosition(2), Color3.fromRGB(150, 50, 50))
    
    -- 切换目标按钮
    local SwapTargetButton = CreateButton("切换目标", ButtonContainer, GetButtonPosition(3), Color3.fromRGB(150, 150, 50))
    
    -- 穿墙模式按钮
    local WallhackButton = CreateButton("穿墙模式: 关闭", ButtonContainer, GetButtonPosition(4), Color3.fromRGB(50, 100, 150))
    
    -- 穿墙视野按钮
    local WallVisionButton = CreateButton("穿墙视野: 关闭", ButtonContainer, GetButtonPosition(5), Color3.fromRGB(50, 50, 150))

    -- 状态显示
    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Name = "StatusLabel"
    StatusLabel.Size = UDim2.new(0.8, 0, 0.15, 0)
    StatusLabel.Position = GetButtonPosition(6)
    StatusLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    StatusLabel.BackgroundTransparency = 0.3
    StatusLabel.BorderSizePixel = 0
    StatusLabel.Text = "状态: 就绪"
    StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    StatusLabel.TextSize = UI.FontSize
    StatusLabel.TextWrapped = true
    StatusLabel.Parent = ButtonContainer
    
    local StatusCorner = Instance.new("UICorner")
    StatusCorner.CornerRadius = UDim.new(0, 8)
    StatusCorner.Parent = StatusLabel

    return ScreenGui, MainFrame, StartButton, StopButton, SwapTargetButton, WallhackButton, WallVisionButton, StatusLabel, DragHandle
end

-- 获取所有玩家
local function GetAllPlayers()
    local players = {}
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(players, player)
        end
    end
    return players
end

-- 查找最近的玩家
local function FindNearestPlayer()
    local myChar = LocalPlayer.Character
    if not myChar then return nil end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    if not myRoot then return nil end

    local nearestPlayer = nil
    local nearestDistance = math.huge

    for _, player in pairs(GetAllPlayers()) do
        local char = player.Character
        if char then
            local root = char:FindFirstChild("HumanoidRootPart")
            if root then
                local distance = (myRoot.Position - root.Position).Magnitude
                if distance < nearestDistance then
                    nearestDistance = distance
                    nearestPlayer = player
                end
            end
        end
    end

    return nearestPlayer
end

-- 切换目标玩家
function SwapTarget()
    if not Teleport.Active then return end

    Teleport.PlayerList = GetAllPlayers()

    if #Teleport.PlayerList == 0 then
        warn("没有其他玩家可切换")
        return
    end

    local currentIndex = 1
    for i, player in ipairs(Teleport.PlayerList) do
        if player == Teleport.Target then
            currentIndex = i
            break
        end
    end

    local nextIndex = currentIndex % #Teleport.PlayerList + 1
    Teleport.Target = Teleport.PlayerList[nextIndex]
    print("已切换到目标: " .. Teleport.Target.Name)
end

-- 停止传送
function StopTeleport()
    if not Teleport.Active then return end

    Teleport.Active = false
    if Teleport.Connection then
        Teleport.Connection:Disconnect()
        Teleport.Connection = nil
    end

    print("传送已停止")
end

-- 传送循环
local function TeleportRoutine()
    if not Teleport.Active then return end

    local myChar = LocalPlayer.Character
    local targetChar = Teleport.Target and Teleport.Target.Character

    if not myChar or not targetChar then
        StopTeleport()
        return
    end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")

    if myRoot and targetRoot then
        -- 正下方传送：5.5格高度
        local teleportPosition = targetRoot.Position + Vector3.new(0, -5.5, 0)
        myRoot.CFrame = CFrame.new(teleportPosition)
    end
end

-- 开始传送
local function StartTeleport()
    if Teleport.Active then return end

    local myChar = LocalPlayer.Character
    if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then
        warn("角色未加载或没有HumanoidRootPart")
        return
    end

    Teleport.Origin = myChar.HumanoidRootPart.CFrame
    Teleport.PlayerList = GetAllPlayers()
    Teleport.Target = FindNearestPlayer()

    if not Teleport.Target then
        warn("未找到目标玩家")
        return
    end

    Teleport.Active = true
    Teleport.Connection = RunService.Heartbeat:Connect(function()
        TeleportRoutine()
    end)
end

-- 切换穿墙模式
local function ToggleWallhack()
    Teleport.Wallhack = not Teleport.Wallhack
    
    local localChar = LocalPlayer.Character
    if not localChar then return end
    
    if Teleport.Wallhack then
        -- 启用穿墙
        for _, part in ipairs(localChar:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        print("穿墙模式已启用")
    else
        -- 禁用穿墙
        for _, part in ipairs(localChar:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
        print("穿墙模式已禁用")
    end
end

-- 切换穿墙视野
local function ToggleWallVision()
    Teleport.WallVision = not Teleport.WallVision

    if Teleport.WallVision then
        -- 启用视野穿墙
        Teleport.OriginalTransparency = {}

        -- 使所有墙壁透明
        for _, part in ipairs(workspace:GetDescendants()) do
            if part:IsA("BasePart") and part.Transparency < 0.5 then
                Teleport.OriginalTransparency[part] = part.Transparency
                part.Transparency = 0.7
            end
        end

        -- 使地面透明
        local terrain = workspace:FindFirstChildOfClass("Terrain")
        if terrain then
            Teleport.OriginalTransparency[terrain] = 0
            terrain.Transparency = 0.5
        end
        print("穿墙视野已启用")
    else
        -- 恢复原始透明度
        for part, transparency in pairs(Teleport.OriginalTransparency) do
            if part and part.Parent then
                part.Transparency = transparency
            end
        end
        Teleport.OriginalTransparency = {}
        print("穿墙视野已禁用")
    end
end

-- 初始化UI和功能
local function Initialize()
    -- 确保玩家和PlayerGui存在
    if not LocalPlayer or not LocalPlayer:FindFirstChild("PlayerGui") then
        warn("等待玩家加载...")
        LocalPlayer:WaitForChild("PlayerGui")
    end

    -- 创建UI
    local success, result = pcall(function()
        return CreateUI()
    end)
    
    if not success then
        warn("创建UI失败: " .. tostring(result))
        return
    end

    local ScreenGui, MainFrame, StartButton, StopButton, SwapTargetButton, WallhackButton, WallVisionButton, StatusLabel, DragHandle = result

    -- 拖拽功能（优化的手机端拖拽）
    local dragStartPos, containerStartPos
    
    DragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragStartPos = input.Position
            containerStartPos = Vector2.new(MainFrame.AbsolutePosition.X, MainFrame.AbsolutePosition.Y)
        end
    end)
    
    UIS.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch and dragStartPos then
            local delta = input.Position - dragStartPos
            MainFrame.Position = UDim2.new(0, containerStartPos.X + delta.X, 0, containerStartPos.Y + delta.Y)
        end
    end)
    
    UIS.InputEnded:Connect(function()
        dragStartPos = nil
    end)

    -- 绑定按钮事件
    StartButton.MouseButton1Click:Connect(StartTeleport)
    StopButton.MouseButton1Click:Connect(StopTeleport)
    SwapTargetButton.MouseButton1Click:Connect(SwapTarget)
    WallhackButton.MouseButton1Click:Connect(ToggleWallhack)
    WallVisionButton.MouseButton1Click:Connect(ToggleWallVision)

    -- 更新UI状态
    RunService.Heartbeat:Connect(function()
        -- 更新传送状态
        if Teleport.Active then
            StatusLabel.Text = "状态: 传送中 - " .. (Teleport.Target and Teleport.Target.Name or "无目标")
            StatusLabel.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
        else
            StatusLabel.Text = "状态: 就绪"
            StatusLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        end

        -- 更新穿墙模式按钮状态
        if Teleport.Wallhack then
            WallhackButton.Text = "穿墙模式: 开启"
            WallhackButton.BackgroundColor3 = Color3.fromRGB(80, 130, 200)
        else
            WallhackButton.Text = "穿墙模式: 关闭"
            WallhackButton.BackgroundColor3 = Color3.fromRGB(50, 100, 150)
        end

        -- 更新穿墙视野按钮状态
        if Teleport.WallVision then
            WallVisionButton.Text = "穿墙视野: 开启"
            WallVisionButton.BackgroundColor3 = Color3.fromRGB(80, 80, 200)
        else
            WallVisionButton.Text = "穿墙视野: 关闭"
            WallVisionButton.BackgroundColor3 = Color3.fromRGB(50, 50, 150)
        end
    end)
    
    print("传送UI已成功加载！")
end

-- 等待游戏完全加载后再初始化
local function SafeInitialize()
    pcall(function()
        -- 等待玩家加载完成
        if not LocalPlayer.Character then
            LocalPlayer.CharacterAdded:Wait()
        end
        
        -- 短暂延迟确保一切就绪
        wait(2)
        
        Initialize()
    end)
end

-- 玩家加入/离开事件
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        table.insert(Teleport.PlayerList, player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    for i, p in ipairs(Teleport.PlayerList) do
        if p == player then
            table.remove(Teleport.PlayerList, i)
            break
        end
    end
end)

-- 异常处理
LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("Humanoid").Died:Connect(function()
        if Teleport.Active then
            StopTeleport()
        end
    end)
end)

-- 开始初始化
SafeInitialize()
print("传送脚本加载完成 | 方向:正下方(Y-5.5) | UI优化版")