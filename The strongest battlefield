-- Roblox手机端极速传送脚本 (高级UI版)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local Camera = workspace.CurrentCamera

-- 传送功能变量
local Teleport = {
    Active = false,
    Target = nil,
    Origin = nil,
    Connection = nil,
    PlayerList = {},
    AntiThrow = false,
    BodyForce = nil,
    LastPosition = nil,
    WallVision = false,
    OriginalTransparency = {}
}

-- 创建通知系统
local function ShowNotification(message, color)
    color = color or Color3.fromRGB(0, 150, 255)
    
    local NotificationGui = Instance.new("ScreenGui")
    NotificationGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    
    local NotificationFrame = Instance.new("Frame")
    NotificationFrame.Parent = NotificationGui
    NotificationFrame.Size = UDim2.new(0, 200, 0, 50)
    NotificationFrame.Position = UDim2.new(0.5, -100, 0.1, 0)
    NotificationFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    NotificationFrame.BackgroundTransparency = 0.1
    
    local NotificationCorner = Instance.new("UICorner")
    NotificationCorner.Parent = NotificationFrame
    NotificationCorner.CornerRadius = UDim.new(0, 8)
    
    local NotificationStroke = Instance.new("UIStroke")
    NotificationStroke.Parent = NotificationFrame
    NotificationStroke.Color = color
    NotificationStroke.Thickness = 2
    
    local NotificationText = Instance.new("TextLabel")
    NotificationText.Parent = NotificationFrame
    NotificationText.Size = UDim2.new(1, -20, 1, -10)
    NotificationText.Position = UDim2.new(0, 10, 0, 5)
    NotificationText.BackgroundTransparency = 1
    NotificationText.Text = message
    NotificationText.TextColor3 = Color3.fromRGB(220, 220, 255)
    NotificationText.TextSize = 14
    NotificationText.Font = Enum.Font.Gotham
    NotificationText.TextWrapped = true
    
    -- 1秒后自动消失
    delay(1, function()
        for i = 0, 1, 0.1 do
            NotificationFrame.BackgroundTransparency = i
            NotificationText.TextTransparency = i
            wait(0.05)
        end
        NotificationGui:Destroy()
    end)
end

-- 创建高级UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.Name = "AdvancedTeleportUI"

local MainFrame = Instance.new("Frame")
MainFrame.Parent = ScreenGui
MainFrame.Size = UDim2.new(0, 180, 0, 220)
MainFrame.Position = UDim2.new(0.5, -90, 0.5, -110)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
MainFrame.Active = true
MainFrame.Draggable = true

-- 外发光效果
local Glow = Instance.new("ImageLabel")
Glow.Parent = MainFrame
Glow.Size = UDim2.new(1, 20, 1, 20)
Glow.Position = UDim2.new(0, -10, 0, -10)
Glow.BackgroundTransparency = 1
Glow.Image = "rbxassetid://8992230673"
Glow.ImageColor3 = Color3.fromRGB(0, 80, 255)
Glow.ImageTransparency = 0.8
Glow.ScaleType = Enum.ScaleType.Slice
Glow.SliceCenter = Rect.new(49, 49, 450, 450)

-- 圆角
local Corner = Instance.new("UICorner")
Corner.Parent = MainFrame
Corner.CornerRadius = UDim.new(0, 12)

-- 边框
local Stroke = Instance.new("UIStroke")
Stroke.Parent = MainFrame
Stroke.Color = Color3.fromRGB(60, 120, 255)
Stroke.Thickness = 2
Stroke.Transparency = 0.3

-- 标题栏
local Header = Instance.new("Frame")
Header.Parent = MainFrame
Header.Size = UDim2.new(1, 0, 0, 32)
Header.Position = UDim2.new(0, 0, 0, 0)
Header.BackgroundColor3 = Color3.fromRGB(25, 25, 40)
Header.BackgroundTransparency = 0.1

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.Parent = Header
HeaderCorner.CornerRadius = UDim.new(0, 12)

-- 标题文字
local Title = Instance.new("TextLabel")
Title.Parent = Header
Title.Size = UDim2.new(1, -50, 1, 0) -- 为最小化按钮留出空间
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "传送控制面板"
Title.TextColor3 = Color3.fromRGB(180, 200, 255)
Title.TextSize = 14
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left

-- 状态指示器
local Status = Instance.new("Frame")
Status.Parent = Header
Status.Size = UDim2.new(0, 8, 0, 8)
Status.Position = UDim2.new(1, -40, 0.5, -4) -- 调整位置为最小化按钮留出空间
Status.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
Status.BorderSizePixel = 0

local StatusCorner = Instance.new("UICorner")
StatusCorner.Parent = Status
StatusCorner.CornerRadius = UDim.new(1, 0)

-- 添加最小化按钮
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Parent = Header
MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
MinimizeButton.Position = UDim2.new(1, -30, 0.5, -12)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 80)
MinimizeButton.BackgroundTransparency = 0.2
MinimizeButton.Text = "-"
MinimizeButton.TextColor3 = Color3.fromRGB(220, 220, 255)
MinimizeButton.TextSize = 16
MinimizeButton.Font = Enum.Font.GothamBold
MinimizeButton.ZIndex = 2

local MinimizeCorner = Instance.new("UICorner")
MinimizeCorner.Parent = MinimizeButton
MinimizeCorner.CornerRadius = UDim.new(0, 6)

local MinimizeStroke = Instance.new("UIStroke")
MinimizeStroke.Parent = MinimizeButton
MinimizeStroke.Color = Color3.fromRGB(100, 150, 255)
MinimizeStroke.Thickness = 1

-- 内容区域
local Content = Instance.new("Frame")
Content.Parent = MainFrame
Content.Size = UDim2.new(1, -16, 1, -48)
Content.Position = UDim2.new(0, 8, 0, 40)
Content.BackgroundTransparency = 1

-- 创建功能按钮
local function CreateButton(name, yPosition, hasIndicator)
    local Button = Instance.new("TextButton")
    Button.Name = name
    Button.Size = UDim2.new(1, 0, 0, 30)
    Button.Position = UDim2.new(0, 0, 0, yPosition)
    Button.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    Button.BackgroundTransparency = 0.2
    Button.TextColor3 = Color3.fromRGB(220, 220, 255)
    Button.Text = name
    Button.TextSize = 12
    Button.Font = Enum.Font.Gotham
    Button.Parent = Content
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.Parent = Button
    ButtonCorner.CornerRadius = UDim.new(0, 6)
    
    local ButtonStroke = Instance.new("UIStroke")
    ButtonStroke.Parent = Button
    ButtonStroke.Color = Color3.fromRGB(80, 120, 200)
    ButtonStroke.Thickness = 1
    
    -- 状态指示器
    if hasIndicator then
        local Indicator = Instance.new("Frame")
        Indicator.Name = "Indicator"
        Indicator.Size = UDim2.new(0, 8, 0, 8)
        Indicator.Position = UDim2.new(1, -12, 0.5, -4)
        Indicator.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        Indicator.BorderSizePixel = 0
        Indicator.Parent = Button
        
        local IndicatorCorner = Instance.new("UICorner")
        IndicatorCorner.Parent = Indicator
        IndicatorCorner.CornerRadius = UDim.new(1, 0)
    end
    
    return Button
end

-- 创建所有按钮
local StartButton = CreateButton("开始传送", 0, false)
local SwapButton = CreateButton("切换目标", 35, false)
local StopButton = CreateButton("停止传送", 70, false)
local AntiThrowButton = CreateButton("防甩模式", 105, true)
local WallVisionButton = CreateButton("穿墙视野", 140, true)

-- 更新按钮状态
local function UpdateButtonState(buttonName, isActive)
    local button = Content:FindFirstChild(buttonName)
    if button then
        local indicator = button:FindFirstChild("Indicator")
        if indicator then
            if isActive then
                indicator.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
                button.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
            else
                indicator.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
                button.BackgroundColor3 = Color3.fromRGB(60, 40, 40)
            end
        end
    end
end

-- 最小化功能
local minimized = false
MinimizeButton.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        -- 最小化状态
        MainFrame:TweenSize(UDim2.new(0, 180, 0, 32), "Out", "Quad", 0.3, true)
        MinimizeButton.Text = "+"
        Content.Visible = false
        
        -- 隐藏外发光效果
        Glow.Visible = false
    else
        -- 恢复正常状态
        MainFrame:TweenSize(UDim2.new(0, 180, 0, 220), "Out", "Quad", 0.3, true)
        MinimizeButton.Text = "-"
        Content.Visible = true
        
        -- 显示外发光效果
        Glow.Visible = true
    end
end)

-- 获取所有玩家列表
local function GetAllPlayers()
    local players = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            table.insert(players, player)
        end
    end
    return players
end

-- 寻找最近玩家
local function FindNearestPlayer()
    local nearest, minDist = nil, math.huge
    local myChar = Players.LocalPlayer.Character
    if not myChar then return end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end

    for _, player in ipairs(Teleport.PlayerList) do
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local dist = (myRoot.Position - char.HumanoidRootPart.Position).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = player
            end
        end
    end
    return nearest
end

-- 设置零重力
local function SetZeroGravity(character)
    if not character then return end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end

    -- 移除现有BodyForce
    if Teleport.BodyForce then
        Teleport.BodyForce:Destroy()
        Teleport.BodyForce = nil
    end

    -- 创建新的BodyForce抵消重力
    Teleport.BodyForce = Instance.new("BodyForce")
    Teleport.BodyForce.Name = "AntiGravity"
    Teleport.BodyForce.Force = Vector3.new(0, workspace.Gravity * humanoidRootPart:GetMass(), 0)
    Teleport.BodyForce.Parent = humanoidRootPart
end

-- 移除零重力
local function RemoveZeroGravity()
    if Teleport.BodyForce then
        Teleport.BodyForce:Destroy()
        Teleport.BodyForce = nil
    end
end

-- 检测异常移动（防甩核心）
local function CheckAbnormalMovement(currentPos)
    if not Teleport.LastPosition then
        Teleport.LastPosition = currentPos
        return false
    end

    local distance = (currentPos - Teleport.LastPosition).Magnitude
    Teleport.LastPosition = currentPos

    -- 如果移动距离超过预期值，视为异常移动
    return distance > 10
end

-- 传送逻辑
local function TeleportRoutine()
    if not Teleport.Active then return end

    local myChar = Players.LocalPlayer.Character
    local targetChar = Teleport.Target and Teleport.Target.Character

    if not myChar or not targetChar then
        StopTeleport()
        return
    end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")

    if myRoot and targetRoot then
        -- 检测异常移动（防甩）
        if CheckAbnormalMovement(myRoot.Position) then
            print("检测到异常移动，重新传送到目标下方")
        end

        -- 设置零重力防止掉落
        SetZeroGravity(myChar)

        -- 正下方传送：5.5格高度
        local newPos = Vector3.new(
            targetRoot.Position.X,
            targetRoot.Position.Y - 5.5,
            targetRoot.Position.Z
        )

        -- 设置位置并面向目标
        myRoot.CFrame = CFrame.new(newPos, targetRoot.Position)
    end
end

-- 视野穿墙模式
local function ToggleWallVision()
    Teleport.WallVision = not Teleport.WallVision
    UpdateButtonState("穿墙视野", Teleport.WallVision)

    if Teleport.WallVision then
        -- 启用视野穿墙
        Teleport.OriginalTransparency = {}

        -- 使所有墙壁透明
        for _, part in ipairs(workspace:GetDescendants()) do
            if part:IsA("BasePart") and part.Transparency < 0.5 then
                Teleport.OriginalTransparency[part] = part.Transparency
                part.Transparency = 0.7
            end
        end

        -- 使地面透明
        for _, terrain in ipairs(workspace:GetChildren()) do
            if terrain:IsA("Terrain") then
                Teleport.OriginalTransparency[terrain] = terrain.Transparency
                terrain.Transparency = 0.6
            end
        end

        ShowNotification("穿墙视野已启用", Color3.fromRGB(0, 200, 255))
    else
        -- 禁用视野穿墙
        for part, transparency in pairs(Teleport.OriginalTransparency) do
            if part:IsA("BasePart") or part:IsA("Terrain") then
                part.Transparency = transparency
            end
        end
        Teleport.OriginalTransparency = {}
        ShowNotification("穿墙视野已禁用", Color3.fromRGB(255, 100, 0))
    end
end

-- 防甩模式
local function ToggleAntiThrow()
    Teleport.AntiThrow = not Teleport.AntiThrow
    UpdateButtonState("防甩模式", Teleport.AntiThrow)

    if Teleport.AntiThrow then
        ShowNotification("防甩模式已启用", Color3.fromRGB(0, 255, 100))
    else
        ShowNotification("防甩模式已禁用", Color3.fromRGB(255, 100, 0))
    end
end

-- 开始传送
local function StartTeleport()
    if Teleport.Active then return end

    Teleport.Origin = Players.LocalPlayer.Character.HumanoidRootPart.CFrame
    Teleport.PlayerList = GetAllPlayers()
    Teleport.Target = FindNearestPlayer()

    if not Teleport.Target then
        ShowNotification("未找到目标玩家", Color3.fromRGB(255, 50, 50))
        return
    end

    Teleport.Active = true
    Teleport.Connection = RunService.Heartbeat:Connect(function()
        TeleportRoutine()
        task.wait(0.001)
    end)

    ShowNotification("传送已启动 - 目标: "..Teleport.Target.Name, Color3.fromRGB(0, 255, 100))
    Status.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
end

-- 切换目标
local function SwapTarget()
    if not Teleport.Active then
        ShowNotification("请先启动传送", Color3.fromRGB(255, 150, 0))
        return
    end

    Teleport.PlayerList = GetAllPlayers()

    if #Teleport.PlayerList == 0 then
        ShowNotification("没有其他玩家可切换", Color3.fromRGB(255, 50, 50))
        return
    end

    local currentIndex = 1
    for i, player in ipairs(Teleport.PlayerList) do
        if player == Teleport.Target then
            currentIndex = i
            break
        end
    end

    local nextIndex = currentIndex % #Teleport.PlayerList + 1
    Teleport.Target = Teleport.PlayerList[nextIndex]

    ShowNotification("已切换到: "..Teleport.Target.Name, Color3.fromRGB(0, 200, 255))
end

-- 停止传送
local function StopTeleport()
    if not Teleport.Active then
        ShowNotification("传送未启动", Color3.fromRGB(255, 150, 0))
        return
    end

    Teleport.Active = false
    if Teleport.Connection then
        Teleport.Connection:Disconnect()
    end

    -- 移除零重力
    RemoveZeroGravity()

    Teleport.LastPosition = nil

    ShowNotification("传送已停止", Color3.fromRGB(255, 100, 0))
    Status.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
end

-- 按钮点击事件
StartButton.MouseButton1Click:Connect(StartTeleport)
SwapButton.MouseButton1Click:Connect(SwapTarget)
StopButton.MouseButton1Click:Connect(StopTeleport)
AntiThrowButton.MouseButton1Click:Connect(ToggleAntiThrow)
WallVisionButton.MouseButton1Click:Connect(ToggleWallVision)

-- 玩家加入/离开事件
Players.PlayerAdded:Connect(function(player)
    if player ~= Players.LocalPlayer then
        table.insert(Teleport.PlayerList, player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    for i, p in ipairs(Teleport.PlayerList) do
        if p == player then
            table.remove(Teleport.PlayerList, i)
            break
        end
    end
end)

-- 异常处理
Players.LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("Humanoid").Died:Connect(function()
        if Teleport.Active then
            StopTeleport()
        end
    end)

    -- 角色重生时重新应用零重力
    if Teleport.Active then
        wait(1)
        SetZeroGravity(char)
    end
end)

-- 显示启动通知
ShowNotification("传送控制面板已加载", Color3.fromRGB(0, 150, 255))

print("高级传送UI已加载完成")
print("功能: 开始传送 | 切换目标 | 停止传送 | 防甩模式 | 穿墙视野 | 最小化")