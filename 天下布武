-- Roblox手机端传送控制脚本 (最终优化版)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- 传送功能变量
local Teleport = {
    Active = false,
    Target = nil,
    Connection = nil,
    PlayerList = {},
    NPCTarget = nil,
    AntiThrow = true,
    WallVision = false,
    OriginalTransparency = {},
    
    -- 环绕模式
    HorizontalOrbitActive = false,
    HorizontalOrbitConnection = nil,
    OrbitRadius = 10,
    HorizontalSpeed = 2,
    HorizontalAngle = 0,
    
    -- 甩飞功能
    ThrowForce = 50,
    ThrowActive = false,
    ThrowTargetPlayer = nil,
    LastThrowTime = 0
}

-- 创建通知系统
local function ShowNotification(message, color)
    color = color or Color3.fromRGB(0, 150, 255)
    
    local NotificationGui = Instance.new("ScreenGui")
    NotificationGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    NotificationGui.ResetOnSpawn = false
    
    local NotificationFrame = Instance.new("Frame")
    NotificationFrame.Parent = NotificationGui
    NotificationFrame.Size = UDim2.new(0, 200, 0, 50)
    NotificationFrame.Position = UDim2.new(0.5, -100, 0.1, 0)
    NotificationFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    NotificationFrame.BackgroundTransparency = 0.1
    
    local NotificationCorner = Instance.new("UICorner")
    NotificationCorner.Parent = NotificationFrame
    NotificationCorner.CornerRadius = UDim.new(0, 8)
    
    local NotificationStroke = Instance.new("UIStroke")
    NotificationStroke.Parent = NotificationFrame
    NotificationStroke.Color = color
    NotificationStroke.Thickness = 2
    
    local NotificationText = Instance.new("TextLabel")
    NotificationText.Parent = NotificationFrame
    NotificationText.Size = UDim2.new(1, -20, 1, -10)
    NotificationText.Position = UDim2.new(0, 10, 0, 5)
    NotificationText.BackgroundTransparency = 1
    NotificationText.Text = message
    NotificationText.TextColor3 = Color3.fromRGB(220, 220, 255)
    NotificationText.TextSize = 14
    NotificationText.Font = Enum.Font.Gotham
    NotificationText.TextWrapped = true
    
    delay(2, function()
        for i = 0, 1, 0.1 do
            NotificationFrame.BackgroundTransparency = i
            NotificationText.TextTransparency = i
            wait(0.05)
        end
        NotificationGui:Destroy()
    end)
end

-- 创建紧凑主UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.Name = "TeleportControlUI"
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Parent = ScreenGui
MainFrame.Size = UDim2.new(0, 160, 0, 380) -- 进一步缩小
MainFrame.Position = UDim2.new(0.5, -80, 0.5, -190)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
MainFrame.Active = true
MainFrame.Draggable = true

-- 外发光效果
local Glow = Instance.new("ImageLabel")
Glow.Parent = MainFrame
Glow.Size = UDim2.new(1, 20, 1, 20)
Glow.Position = UDim2.new(0, -10, 0, -10)
Glow.BackgroundTransparency = 1
Glow.Image = "rbxassetid://8992230673"
Glow.ImageColor3 = Color3.fromRGB(0, 80, 255)
Glow.ImageTransparency = 0.8
Glow.ScaleType = Enum.ScaleType.Slice
Glow.SliceCenter = Rect.new(49, 49, 450, 450)

-- 圆角
local Corner = Instance.new("UICorner")
Corner.Parent = MainFrame
Corner.CornerRadius = UDim.new(0, 10)

-- 边框
local Stroke = Instance.new("UIStroke")
Stroke.Parent = MainFrame
Stroke.Color = Color3.fromRGB(60, 120, 255)
Stroke.Thickness = 2
Stroke.Transparency = 0.3

-- 标题栏
local Header = Instance.new("Frame")
Header.Parent = MainFrame
Header.Size = UDim2.new(1, 0, 0, 25) -- 缩小标题栏
Header.Position = UDim2.new(0, 0, 0, 0)
Header.BackgroundColor3 = Color3.fromRGB(25, 25, 40)
Header.BackgroundTransparency = 0.1

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.Parent = Header
HeaderCorner.CornerRadius = UDim.new(0, 10)

-- 标题文字
local Title = Instance.new("TextLabel")
Title.Parent = Header
Title.Size = UDim2.new(1, -50, 1, 0)
Title.Position = UDim2.new(0, 8, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "传送控制"
Title.TextColor3 = Color3.fromRGB(180, 200, 255)
Title.TextSize = 11 -- 缩小字体
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left

-- 状态指示器
local Status = Instance.new("Frame")
Status.Parent = Header
Status.Size = UDim2.new(0, 6, 0, 6)
Status.Position = UDim2.new(1, -35, 0.5, -3)
Status.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
Status.BorderSizePixel = 0

local StatusCorner = Instance.new("UICorner")
StatusCorner.Parent = Status
StatusCorner.CornerRadius = UDim.new(1, 0)

-- 最小化按钮
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Parent = Header
MinimizeButton.Size = UDim2.new(0, 20, 0, 20)
MinimizeButton.Position = UDim2.new(1, -25, 0.5, -10)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 80)
MinimizeButton.BackgroundTransparency = 0.2
MinimizeButton.Text = "-"
MinimizeButton.TextColor3 = Color3.fromRGB(220, 220, 255)
MinimizeButton.TextSize = 13
MinimizeButton.Font = Enum.Font.GothamBold

local MinimizeCorner = Instance.new("UICorner")
MinimizeCorner.Parent = MinimizeButton
MinimizeCorner.CornerRadius = UDim.new(0, 5)

local MinimizeStroke = Instance.new("UIStroke")
MinimizeStroke.Parent = MinimizeButton
MinimizeStroke.Color = Color3.fromRGB(100, 150, 255)
MinimizeStroke.Thickness = 1

-- 滚动框架
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Parent = MainFrame
ScrollFrame.Size = UDim2.new(1, -10, 1, -35)
ScrollFrame.Position = UDim2.new(0, 5, 0, 28)
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.ScrollBarThickness = 3
ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(80, 120, 200)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 620)

-- 内容容器
local Content = Instance.new("Frame")
Content.Parent = ScrollFrame
Content.Size = UDim2.new(1, 0, 0, 620)
Content.BackgroundTransparency = 1

-- 创建紧凑功能按钮
local function CreateButton(name, yPosition, hasIndicator)
    local Button = Instance.new("TextButton")
    Button.Name = name
    Button.Size = UDim2.new(1, 0, 0, 28) -- 缩小按钮高度
    Button.Position = UDim2.new(0, 0, 0, yPosition)
    Button.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    Button.BackgroundTransparency = 0.2
    Button.TextColor3 = Color3.fromRGB(220, 220, 255)
    Button.Text = name
    Button.TextSize = 10 -- 缩小字体
    Button.Font = Enum.Font.Gotham
    Button.Parent = Content
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.Parent = Button
    ButtonCorner.CornerRadius = UDim.new(0, 6)
    
    local ButtonStroke = Instance.new("UIStroke")
    ButtonStroke.Parent = Button
    ButtonStroke.Color = Color3.fromRGB(80, 120, 200)
    ButtonStroke.Thickness = 1
    
    if hasIndicator then
        local Indicator = Instance.new("Frame")
        Indicator.Name = "Indicator"
        Indicator.Size = UDim2.new(0, 6, 0, 6)
        Indicator.Position = UDim2.new(1, -10, 0.5, -3)
        Indicator.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        Indicator.BorderSizePixel = 0
        Indicator.Parent = Button
        
        local IndicatorCorner = Instance.new("UICorner")
        IndicatorCorner.Parent = Indicator
        IndicatorCorner.CornerRadius = UDim.new(1, 0)
    end
    
    return Button
end

-- 创建紧凑输入控件
local function CreateInputControl(label, yPosition, defaultValue, minValue, maxValue)
    local ControlFrame = Instance.new("Frame")
    ControlFrame.Size = UDim2.new(1, 0, 0, 23) -- 缩小控件高度
    ControlFrame.Position = UDim2.new(0, 0, 0, yPosition)
    ControlFrame.BackgroundTransparency = 1
    ControlFrame.Parent = Content
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(0.4, 0, 1, 0)
    Label.Position = UDim2.new(0, 0, 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = label
    Label.TextColor3 = Color3.fromRGB(180, 200, 255)
    Label.TextSize = 9 -- 缩小字体
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = ControlFrame
    
    local ValueBox = Instance.new("TextButton")
    ValueBox.Size = UDim2.new(0.6, 0, 1, 0)
    ValueBox.Position = UDim2.new(0.4, 0, 0, 0)
    ValueBox.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    ValueBox.Text = tostring(defaultValue)
    ValueBox.TextColor3 = Color3.fromRGB(0, 200, 255)
    ValueBox.TextSize = 9 -- 缩小字体
    ValueBox.Font = Enum.Font.Gotham
    ValueBox.Parent = ControlFrame
    
    local ValueCorner = Instance.new("UICorner")
    ValueCorner.Parent = ValueBox
    ValueCorner.CornerRadius = UDim.new(0, 4)
    
    local ValueStroke = Instance.new("UIStroke")
    ValueStroke.Parent = ValueBox
    ValueStroke.Color = Color3.fromRGB(80, 120, 200)
    ValueStroke.Thickness = 1
    
    return {
        Frame = ControlFrame,
        Box = ValueBox,
        Value = defaultValue,
        Min = minValue,
        Max = maxValue
    }
end

-- 创建所有按钮和控件
local StartButton = CreateButton("开始传送", 0, false)
local PlayerSelectButton = CreateButton("选择玩家", 32, false)
local NPCSelectButton = CreateButton("选择NPC", 64, false)
local StopButton = CreateButton("停止传送", 96, false)
local AntiThrowButton = CreateButton("防甩飞: 开启", 128, true)
local WallVisionButton = CreateButton("穿墙视野", 160, true)
local ParallelOrbitButton = CreateButton("平行环绕", 192, true)

-- 分隔线1
local Separator1 = Instance.new("Frame")
Separator1.Parent = Content
Separator1.Size = UDim2.new(1, 0, 0, 1)
Separator1.Position = UDim2.new(0, 0, 0, 224)
Separator1.BackgroundColor3 = Color3.fromRGB(60, 120, 255)
Separator1.BackgroundTransparency = 0.5

local SeparatorLabel1 = Instance.new("TextLabel")
SeparatorLabel1.Parent = Content
SeparatorLabel1.Size = UDim2.new(1, 0, 0, 16)
SeparatorLabel1.Position = UDim2.new(0, 0, 0, 228)
SeparatorLabel1.BackgroundTransparency = 1
SeparatorLabel1.Text = "环绕设置"
SeparatorLabel1.TextColor3 = Color3.fromRGB(120, 160, 255)
SeparatorLabel1.TextSize = 9
SeparatorLabel1.Font = Enum.Font.GothamBold

-- 环绕控制
local RadiusControl = CreateInputControl("环绕半径:", 248, 10, 5, 50)
local OrbitSpeedControl = CreateInputControl("环绕速度:", 275, 2, 0.5, 10)

-- 分隔线2
local Separator2 = Instance.new("Frame")
Separator2.Parent = Content
Separator2.Size = UDim2.new(1, 0, 0, 1)
Separator2.Position = UDim2.new(0, 0, 0, 302)
Separator2.BackgroundColor3 = Color3.fromRGB(255, 120, 60)
Separator2.BackgroundTransparency = 0.5

local SeparatorLabel2 = Instance.new("TextLabel")
SeparatorLabel2.Parent = Content
SeparatorLabel2.Size = UDim2.new(1, 0, 0, 16)
SeparatorLabel2.Position = UDim2.new(0, 0, 0, 306)
SeparatorLabel2.BackgroundTransparency = 1
SeparatorLabel2.Text = "甩飞设置"
SeparatorLabel2.TextColor3 = Color3.fromRGB(255, 160, 120)
SeparatorLabel2.TextSize = 9
SeparatorLabel2.Font = Enum.Font.GothamBold

-- 甩飞功能按钮
local ThrowToggleButton = CreateButton("开启甩飞功能", 326, true)
local ThrowTargetButton = CreateButton("选择甩飞目标", 358, false)
local ThrowExecuteButton = CreateButton("执行甩飞", 390, false)
local ThrowForceControl = CreateInputControl("甩飞力度:", 422, 50, 10, 99999)

-- 分隔线3
local Separator3 = Instance.new("Frame")
Separator3.Parent = Content
Separator3.Size = UDim2.new(1, 0, 0, 1)
Separator3.Position = UDim2.new(0, 0, 0, 454)
Separator3.BackgroundColor3 = Color3.fromRGB(120, 255, 80)
Separator3.BackgroundTransparency = 0.5

local SeparatorLabel3 = Instance.new("TextLabel")
SeparatorLabel3.Parent = Content
SeparatorLabel3.Size = UDim2.new(1, 0, 0, 16)
SeparatorLabel3.Position = UDim2.new(0, 0, 0, 458)
SeparatorLabel3.BackgroundTransparency = 1
SeparatorLabel3.Text = "其他功能"
SeparatorLabel3.TextColor3 = Color3.fromRGB(160, 255, 120)
SeparatorLabel3.TextSize = 9
SeparatorLabel3.Font = Enum.Font.GothamBold

local DeleteUIButton = CreateButton("删除UI", 478, false)

-- 更新按钮状态
local function UpdateButtonState(buttonName, isActive)
    local button = Content:FindFirstChild(buttonName)
    if button then
        local indicator = button:FindFirstChild("Indicator")
        if indicator then
            if isActive then
                indicator.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
                button.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
            else
                indicator.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
                button.BackgroundColor3 = Color3.fromRGB(60, 40, 40)
            end
        end
    end
end

-- 数字输入弹窗
local function CreateNumberInputPopup(currentValue, minValue, maxValue, callback)
    local PopupGui = Instance.new("ScreenGui")
    PopupGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    
    local PopupFrame = Instance.new("Frame")
    PopupFrame.Parent = PopupGui
    PopupFrame.Size = UDim2.new(0, 200, 0, 120)
    PopupFrame.Position = UDim2.new(0.5, -100, 0.5, -60)
    PopupFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 35)
    PopupFrame.Active = true
    PopupFrame.Draggable = true
    
    local PopupCorner = Instance.new("UICorner")
    PopupCorner.Parent = PopupFrame
    PopupCorner.CornerRadius = UDim.new(0, 10)
    
    local PopupStroke = Instance.new("UIStroke")
    PopupStroke.Parent = PopupFrame
    PopupStroke.Color = Color3.fromRGB(80, 120, 200)
    PopupStroke.Thickness = 2
    
    local Title = Instance.new("TextLabel")
    Title.Parent = PopupFrame
    Title.Size = UDim2.new(1, -20, 0, 20)
    Title.Position = UDim2.new(0, 10, 0, 8)
    Title.BackgroundTransparency = 1
    Title.Text = "输入数值 ("..minValue.."-"..maxValue..")"
    Title.TextColor3 = Color3.fromRGB(220, 220, 255)
    Title.TextSize = 11
    Title.Font = Enum.Font.GothamBold
    
    local InputBox = Instance.new("TextBox")
    InputBox.Parent = PopupFrame
    InputBox.Size = UDim2.new(1, -40, 0, 25)
    InputBox.Position = UDim2.new(0, 20, 0, 35)
    InputBox.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    InputBox.Text = tostring(currentValue)
    InputBox.TextColor3 = Color3.fromRGB(220, 220, 255)
    InputBox.TextSize = 12
    InputBox.Font = Enum.Font.Gotham
    InputBox.ClearTextOnFocus = false
    
    local InputCorner = Instance.new("UICorner")
    InputCorner.Parent = InputBox
    InputCorner.CornerRadius = UDim.new(0, 6)
    
    local InputStroke = Instance.new("UIStroke")
    InputStroke.Parent = InputBox
    InputStroke.Color = Color3.fromRGB(80, 120, 200)
    InputStroke.Thickness = 1
    
    local ConfirmButton = Instance.new("TextButton")
    ConfirmButton.Parent = PopupFrame
    ConfirmButton.Size = UDim2.new(0, 60, 0, 22)
    ConfirmButton.Position = UDim2.new(0.5, -70, 1, -35)
    ConfirmButton.BackgroundColor3 = Color3.fromRGB(40, 120, 80)
    ConfirmButton.Text = "确认"
    ConfirmButton.TextColor3 = Color3.fromRGB(220, 220, 255)
    ConfirmButton.TextSize = 11
    ConfirmButton.Font = Enum.Font.Gotham
    
    local ConfirmCorner = Instance.new("UICorner")
    ConfirmCorner.Parent = ConfirmButton
    ConfirmCorner.CornerRadius = UDim.new(0, 5)
    
    local CancelButton = Instance.new("TextButton")
    CancelButton.Parent = PopupFrame
    CancelButton.Size = UDim2.new(0, 60, 0, 22)
    CancelButton.Position = UDim2.new(0.5, 10, 1, -35)
    CancelButton.BackgroundColor3 = Color3.fromRGB(120, 40, 40)
    CancelButton.Text = "取消"
    CancelButton.TextColor3 = Color3.fromRGB(220, 220, 255)
    CancelButton.TextSize = 11
    CancelButton.Font = Enum.Font.Gotham
    
    local CancelCorner = Instance.new("UICorner")
    CancelCorner.Parent = CancelButton
    CancelCorner.CornerRadius = UDim.new(0, 5)
    
    ConfirmButton.MouseButton1Click:Connect(function()
        local inputText = InputBox.Text
        local numberValue = tonumber(inputText)
        
        if numberValue then
            if numberValue < minValue then
                numberValue = minValue
            elseif numberValue > maxValue then
                numberValue = maxValue
            end
            callback(numberValue)
        end
        PopupGui:Destroy()
    end)
    
    CancelButton.MouseButton1Click:Connect(function()
        PopupGui:Destroy()
    end)
    
    InputBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local inputText = InputBox.Text
            local numberValue = tonumber(inputText)
            
            if numberValue then
                if numberValue < minValue then
                    numberValue = minValue
                elseif numberValue > maxValue then
                    numberValue = maxValue
                end
                callback(numberValue)
            end
            PopupGui:Destroy()
        end
    end)
end

-- 最小化功能
local minimized = false
MinimizeButton.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        MainFrame:TweenSize(UDim2.new(0, 160, 0, 25), "Out", "Quad", 0.3, true)
        MinimizeButton.Text = "+"
        ScrollFrame.Visible = false
        Glow.Visible = false
    else
        MainFrame:TweenSize(UDim2.new(0, 160, 0, 380), "Out", "Quad", 0.3, true)
        MinimizeButton.Text = "-"
        ScrollFrame.Visible = true
        Glow.Visible = true
    end
end)

-- 获取所有玩家
local function GetAllPlayers()
    local players = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            table.insert(players, player)
        end
    end
    return players
end

-- 获取所有NPC
local function GetAllNPCs()
    local npcs = {}
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChild("Humanoid") and not Players:GetPlayerFromCharacter(obj) then
            table.insert(npcs, obj)
        end
    end
    return npcs
end

-- 寻找最近目标
local function FindNearestTarget(targetList)
    local nearest, minDist = nil, math.huge
    local myChar = Players.LocalPlayer.Character
    if not myChar then return end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end

    for _, target in ipairs(targetList) do
        local char = target.Character or target
        if char and char:FindFirstChild("HumanoidRootPart") then
            local dist = (myRoot.Position - char.HumanoidRootPart.Position).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = target
            end
        end
    end
    return nearest
end

-- 创建选择UI (玩家/NPC/甩飞目标)
local function CreateSelectionUI(title, itemList, isThrowTarget)
    local SelectGui = Instance.new("ScreenGui")
    SelectGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    SelectGui.Name = "SelectionUI"
    SelectGui.ResetOnSpawn = false
    
    local SelectFrame = Instance.new("Frame")
    SelectFrame.Parent = SelectGui
    SelectFrame.Size = UDim2.new(0, 180, 0, 280)
    SelectFrame.Position = UDim2.new(0.5, -90, 0.5, -140)
    SelectFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 35)
    SelectFrame.Active = true
    SelectFrame.Draggable = true
    
    local SelectCorner = Instance.new("UICorner")
    SelectCorner.Parent = SelectFrame
    SelectCorner.CornerRadius = UDim.new(0, 10)
    
    local SelectStroke = Instance.new("UIStroke")
    SelectStroke.Parent = SelectFrame
    SelectStroke.Color = Color3.fromRGB(80, 120, 200)
    SelectStroke.Thickness = 2
    
    local Title = Instance.new("TextLabel")
    Title.Parent = SelectFrame
    Title.Size = UDim2.new(1, -20, 0, 25)
    Title.Position = UDim2.new(0, 10, 0, 8)
    Title.BackgroundTransparency = 1
    Title.Text = title
    Title.TextColor3 = Color3.fromRGB(220, 220, 255)
    Title.TextSize = 12
    Title.Font = Enum.Font.GothamBold
    
    local ItemScroll = Instance.new("ScrollingFrame")
    ItemScroll.Parent = SelectFrame
    ItemScroll.Size = UDim2.new(1, -20, 1, -70)
    ItemScroll.Position = UDim2.new(0, 10, 0, 40)
    ItemScroll.BackgroundTransparency = 1
    ItemScroll.ScrollBarThickness = 4
    
    local ItemListLayout = Instance.new("UIListLayout")
    ItemListLayout.Parent = ItemScroll
    ItemListLayout.SortOrder = Enum.SortOrder.Name
    
    local CloseButton = Instance.new("TextButton")
    CloseButton.Parent = SelectFrame
    CloseButton.Size = UDim2.new(0, 70, 0, 22)
    CloseButton.Position = UDim2.new(0.5, -35, 1, -32)
    CloseButton.BackgroundColor3 = Color3.fromRGB(120, 40, 40)
    CloseButton.Text = "关闭"
    CloseButton.TextColor3 = Color3.fromRGB(220, 220, 255)
    CloseButton.TextSize = 11
    CloseButton.Font = Enum.Font.Gotham
    
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.Parent = CloseButton
    CloseCorner.CornerRadius = UDim.new(0, 5)
    
    -- 填充列表
    ItemScroll.CanvasSize = UDim2.new(0, 0, 0, #itemList * 32)
    
    for _, item in ipairs(itemList) do
        local ItemButton = Instance.new("TextButton")
        ItemButton.Size = UDim2.new(1, 0, 0, 28)
        ItemButton.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
        ItemButton.Text = item.Name or "未知目标"
        ItemButton.TextColor3 = Color3.fromRGB(220, 220, 255)
        ItemButton.TextSize = 10
        ItemButton.Font = Enum.Font.Gotham
        ItemButton.Parent = ItemScroll
        
        local ItemButtonCorner = Instance.new("UICorner")
        ItemButtonCorner.Parent = ItemButton
        ItemButtonCorner.CornerRadius = UDim.new(0, 6)
        
        local ItemButtonStroke = Instance.new("UIStroke")
        ItemButtonStroke.Parent = ItemButton
        ItemButtonStroke.Color = Color3.fromRGB(80, 120, 200)
        ItemButtonStroke.Thickness = 1
        
        ItemButton.MouseButton1Click:Connect(function()
            if isThrowTarget then
                Teleport.ThrowTargetPlayer = item
                ShowNotification("甩飞目标: "..(item.Name or "未知"), Color3.fromRGB(255, 150, 0))
            else
                if item:IsA("Player") then
                    Teleport.Target = item
                    Teleport.NPCTarget = nil
                else
                    Teleport.NPCTarget = item
                    Teleport.Target = nil
                end
                ShowNotification("已选择: "..(item.Name or "未知"), Color3.fromRGB(0, 200, 255))
            end
            SelectGui:Destroy()
        end)
    end
    
    CloseButton.MouseButton1Click:Connect(function()
        SelectGui:Destroy()
    end)
end

-- 优化防甩飞检测
local function CheckAntiThrow()
    if not Teleport.AntiThrow or not Teleport.Active then return end
    
    local myChar = Players.LocalPlayer.Character
    if not myChar then return end
    
    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end
    
    local target = Teleport.Target or Teleport.NPCTarget
    if not target then return end
    
    local targetChar = target.Character or target
    if not targetChar then return end
    
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    
    local expectedDistance = 5.5
    local currentDistance = (myRoot.Position - targetRoot.Position).Magnitude
    
    if currentDistance > expectedDistance + 2 then
        local newPos = Vector3.new(
            targetRoot.Position.X,
            targetRoot.Position.Y - expectedDistance,
            targetRoot.Position.Z
        )
        myRoot.CFrame = CFrame.new(newPos, targetRoot.Position)
        task.wait(0.1)
    end
end

-- 传送逻辑
local function TeleportRoutine()
    if not Teleport.Active then return end

    local myChar = Players.LocalPlayer.Character
    local target = Teleport.Target or Teleport.NPCTarget
    if not target then
        StopTeleport()
        return
    end

    local targetChar = target.Character or target
    if not myChar or not targetChar then
        StopTeleport()
        return
    end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")

    if myRoot and targetRoot then
        local newPos = Vector3.new(
            targetRoot.Position.X,
            targetRoot.Position.Y - 5.5,
            targetRoot.Position.Z
        )
        myRoot.CFrame = CFrame.new(newPos, targetRoot.Position)
        CheckAntiThrow()
    end
end

-- 修复平行环绕逻辑 - 真正的水平环绕
local function ParallelOrbitRoutine()
    if not Teleport.HorizontalOrbitActive then return end

    local myChar = Players.LocalPlayer.Character
    local target = Teleport.Target or Teleport.NPCTarget
    if not target then
        StopParallelOrbit()
        return
    end

    local targetChar = target.Character or target
    if not myChar or not targetChar then
        StopParallelOrbit()
        return
    end

    local myRoot = myChar:FindFirstChild("HumanoidRootPart")
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")

    if myRoot and targetRoot then
        Teleport.HorizontalAngle = Teleport.HorizontalAngle + Teleport.HorizontalSpeed * 0.05
        
        -- 真正的水平环绕 (y=0平面)
        local radius = Teleport.OrbitRadius
        local x = targetRoot.Position.X + math.cos(Teleport.HorizontalAngle) * radius
        local z = targetRoot.Position.Z + math.sin(Teleport.HorizontalAngle) * radius
        local y = 0  -- 固定在地面高度
        
        local newPos = Vector3.new(x, y, z)
        myRoot.CFrame = CFrame.new(newPos, targetRoot.Position)
    end
end

-- 强力甩飞功能
local function ThrowTarget()
    local target = Teleport.ThrowTargetPlayer
    if not target then
        ShowNotification("请先选择甩飞目标", Color3.fromRGB(255, 150, 0))
        return
    end

    local targetChar = target.Character or target
    if not targetChar then
        ShowNotification("目标角色不存在", Color3.fromRGB(255, 50, 50))
        return
    end

    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
    if not targetRoot then
        ShowNotification("目标没有HumanoidRootPart", Color3.fromRGB(255, 50, 50))
        return
    end

    -- 检查冷却时间
    local currentTime = tick()
    if currentTime - Teleport.LastThrowTime < 1 then
        ShowNotification("甩飞冷却中...", Color3.fromRGB(255, 150, 0))
        return
    end
    Teleport.LastThrowTime = currentTime

    -- 强力甩飞效果
    local throwDirection = Vector3.new(
        (math.random() - 0.5) * 2 * Teleport.ThrowForce,
        Teleport.ThrowForce * 0.8,  -- 向上分量
        (math.random() - 0.5) * 2 * Teleport.ThrowForce
    )
    
    -- 创建BodyVelocity施加力
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = throwDirection
    bodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
    bodyVelocity.Parent = targetRoot

    -- 强力旋转效果
    local bodyAngularVelocity = Instance.new("BodyAngularVelocity")
    bodyAngularVelocity.AngularVelocity = Vector3.new(
        (math.random() - 0.5) * Teleport.ThrowForce * 0.5,
        (math.random() - 0.5) * Teleport.ThrowForce * 0.5,
        (math.random() - 0.5) * Teleport.ThrowForce * 0.5
    )
    bodyAngularVelocity.MaxTorque = Vector3.new(100000, 100000, 100000)
    bodyAngularVelocity.Parent = targetRoot

    -- 3秒后移除物理效果
    delay(3, function()
        if bodyVelocity and bodyVelocity.Parent then
            bodyVelocity:Destroy()
        end
        if bodyAngularVelocity and bodyAngularVelocity.Parent then
            bodyAngularVelocity:Destroy()
        end
    end)

    ShowNotification("已强力甩飞 " .. (target.Name or "目标"), Color3.fromRGB(255, 150, 0))
end

-- 选择甩飞目标
local function SelectThrowTarget()
    if not Teleport.ThrowActive then
        ShowNotification("请先开启甩飞功能", Color3.fromRGB(255, 150, 0))
        return
    end

    local allTargets = {}
    
    -- 添加玩家
    local players = GetAllPlayers()
    for _, player in ipairs(players) do
        table.insert(allTargets, player)
    end
    
    -- 添加NPC
    local npcs = GetAllNPCs()
    for _, npc in ipairs(npcs) do
        table.insert(allTargets, npc)
    end

    if #allTargets == 0 then
        ShowNotification("没有可选择的甩飞目标", Color3.fromRGB(255, 50, 50))
        return
    end

    CreateSelectionUI("选择甩飞目标", allTargets, true)
end

-- 删除UI
local function DeleteUI()
    ScreenGui:Destroy()
    ShowNotification("UI界面已删除", Color3.fromRGB(255, 100, 0))
end

-- 穿墙视野
local function ToggleWallVision()
    Teleport.WallVision = not Teleport.WallVision
    UpdateButtonState("穿墙视野", Teleport.WallVision)

    if Teleport.WallVision then
        Teleport.OriginalTransparency = {}
        for _, part in ipairs(workspace:GetDescendants()) do
            if part:IsA("BasePart") and part.Transparency < 0.5 then
                Teleport.OriginalTransparency[part] = part.Transparency
                part.Transparency = 0.7
            end
        end
        ShowNotification("穿墙视野已启用", Color3.fromRGB(0, 200, 255))
    else
        for part, transparency in pairs(Teleport.OriginalTransparency) do
            if part:IsA("BasePart") then
                part.Transparency = transparency
            end
        end
        Teleport.OriginalTransparency = {}
        ShowNotification("穿墙视野已禁用", Color3.fromRGB(255, 100, 0))
    end
end

-- 防甩飞切换
local function ToggleAntiThrow()
    if Teleport.ThrowActive then
        ShowNotification("甩飞功能开启时无法启用防甩飞", Color3.fromRGB(255, 150, 0))
        return
    end
    
    Teleport.AntiThrow = not Teleport.AntiThrow
    AntiThrowButton.Text = Teleport.AntiThrow and "防甩飞: 开启" or "防甩飞: 关闭"
    UpdateButtonState("防甩飞: 开启", Teleport.AntiThrow)
    
    if Teleport.AntiThrow then
        ShowNotification("防甩飞模式已启用", Color3.fromRGB(0, 255, 100))
    else
        ShowNotification("防甩飞模式已禁用", Color3.fromRGB(255, 100, 0))
    end
end

-- 开始传送
local function StartTeleport()
    if Teleport.Active then return end

    if not Teleport.Target and not Teleport.NPCTarget then
        ShowNotification("请先选择目标玩家或NPC", Color3.fromRGB(255, 50, 50))
        return
    end

    Teleport.Active = true
    Teleport.Connection = RunService.Heartbeat:Connect(function()
        TeleportRoutine()
        task.wait(0.001)
    end)

    local targetName = Teleport.Target and Teleport.Target.Name or (Teleport.NPCTarget and Teleport.NPCTarget.Name or "未知")
    ShowNotification("传送已启动 - 目标: "..targetName, Color3.fromRGB(0, 255, 100))
    Status.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
end

-- 停止传送
local function StopTeleport()
    if not Teleport.Active then
        ShowNotification("传送未启动", Color3.fromRGB(255, 150, 0))
        return
    end

    Teleport.Active = false
    if Teleport.Connection then
        Teleport.Connection:Disconnect()
    end

    ShowNotification("传送已停止", Color3.fromRGB(255, 100, 0))
    Status.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
end

-- 平行环绕控制
local function StartParallelOrbit()
    if Teleport.HorizontalOrbitActive then return end

    if not Teleport.Target and not Teleport.NPCTarget then
        ShowNotification("请先选择目标玩家或NPC", Color3.fromRGB(255, 50, 50))
        return
    end

    Teleport.HorizontalOrbitActive = true
    Teleport.HorizontalAngle = 0
    Teleport.HorizontalOrbitConnection = RunService.Heartbeat:Connect(function()
        ParallelOrbitRoutine()
        task.wait(0.001)
    end)

    UpdateButtonState("平行环绕", true)
    ShowNotification("平行环绕已启动", Color3.fromRGB(0, 200, 255))
    Status.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
end

local function StopParallelOrbit()
    if not Teleport.HorizontalOrbitActive then
        ShowNotification("平行环绕未启动", Color3.fromRGB(255, 150, 0))
        return
    end

    Teleport.HorizontalOrbitActive = false
    if Teleport.HorizontalOrbitConnection then
        Teleport.HorizontalOrbitConnection:Disconnect()
    end

    UpdateButtonState("平行环绕", false)
    ShowNotification("平行环绕已停止", Color3.fromRGB(255, 100, 0))
    if not Teleport.Active then
        Status.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    end
end

-- 切换平行环绕
local function ToggleParallelOrbit()
    if Teleport.HorizontalOrbitActive then
        StopParallelOrbit()
    else
        StartParallelOrbit()
    end
end

-- 切换甩飞功能
local function ToggleThrow()
    if Teleport.ThrowActive then
        Teleport.ThrowActive = false
        Teleport.ThrowTargetPlayer = nil
        UpdateButtonState("开启甩飞功能", false)
        ShowNotification("甩飞功能已关闭", Color3.fromRGB(255, 100, 0))
        
        if not Teleport.AntiThrow then
            Teleport.AntiThrow = true
            AntiThrowButton.Text = "防甩飞: 开启"
            UpdateButtonState("防甩飞: 开启", true)
        end
    else
        Teleport.ThrowActive = true
        UpdateButtonState("开启甩飞功能", true)
        
        if Teleport.AntiThrow then
            Teleport.AntiThrow = false
            AntiThrowButton.Text = "防甩飞: 关闭"
            UpdateButtonState("防甩飞: 开启", false)
        end
        
        ShowNotification("甩飞功能已开启 - 先选择目标再执行甩飞", Color3.fromRGB(255, 150, 0))
    end
end

-- 选择玩家
local function SelectPlayer()
    local players = GetAllPlayers()
    if #players == 0 then
        ShowNotification("没有其他玩家", Color3.fromRGB(255, 50, 50))
        return
    end
    CreateSelectionUI("选择玩家", players, false)
end

-- 选择NPC
local function SelectNPC()
    local npcs = GetAllNPCs()
    if #npcs == 0 then
        ShowNotification("没有找到NPC", Color3.fromRGB(255, 50, 50))
        return
    end
    CreateSelectionUI("选择NPC", npcs, false)
end

-- 按钮点击事件
StartButton.MouseButton1Click:Connect(StartTeleport)
PlayerSelectButton.MouseButton1Click:Connect(SelectPlayer)
NPCSelectButton.MouseButton1Click:Connect(SelectNPC)
StopButton.MouseButton1Click:Connect(StopTeleport)
AntiThrowButton.MouseButton1Click:Connect(ToggleAntiThrow)
WallVisionButton.MouseButton1Click:Connect(ToggleWallVision)
ParallelOrbitButton.MouseButton1Click:Connect(ToggleParallelOrbit)
ThrowToggleButton.MouseButton1Click:Connect(ToggleThrow)
ThrowTargetButton.MouseButton1Click:Connect(SelectThrowTarget)
ThrowExecuteButton.MouseButton1Click:Connect(ThrowTarget)
DeleteUIButton.MouseButton1Click:Connect(DeleteUI)

-- 控制项事件
RadiusControl.Box.MouseButton1Click:Connect(function()
    CreateNumberInputPopup(RadiusControl.Value, RadiusControl.Min, RadiusControl.Max, function(newValue)
        RadiusControl.Value = newValue
        RadiusControl.Box.Text = tostring(newValue)
        Teleport.OrbitRadius = newValue
    end)
end)

OrbitSpeedControl.Box.MouseButton1Click:Connect(function()
    CreateNumberInputPopup(OrbitSpeedControl.Value, OrbitSpeedControl.Min, OrbitSpeedControl.Max, function(newValue)
        OrbitSpeedControl.Value = newValue
        OrbitSpeedControl.Box.Text = tostring(newValue)
        Teleport.HorizontalSpeed = newValue
    end)
end)

ThrowForceControl.Box.MouseButton1Click:Connect(function()
    CreateNumberInputPopup(ThrowForceControl.Value, ThrowForceControl.Min, ThrowForceControl.Max, function(newValue)
        ThrowForceControl.Value = newValue
        ThrowForceControl.Box.Text = tostring(newValue)
        Teleport.ThrowForce = newValue
    end)
end)

-- 玩家管理
Players.PlayerAdded:Connect(function(player)
    if player ~= Players.LocalPlayer then
        table.insert(Teleport.PlayerList, player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    for i, p in ipairs(Teleport.PlayerList) do
        if p == player then
            table.remove(Teleport.PlayerList, i)
            break
        end
    end
end)

-- 角色重生处理
Players.LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("Humanoid").Died:Connect(function()
        if Teleport.Active then
            StopTeleport()
        end
        if Teleport.HorizontalOrbitActive then
            StopParallelOrbit()
        end
    end)
end)

-- 初始化按钮状态
UpdateButtonState("防甩飞: 开启", Teleport.AntiThrow)
UpdateButtonState("穿墙视野", Teleport.WallVision)
UpdateButtonState("平行环绕", false)
UpdateButtonState("开启甩飞功能", Teleport.ThrowActive)

-- 显示启动通知
ShowNotification("传送控制面板已加载", Color3.fromRGB(0, 150, 255))

print("紧凑传送UI已加载完成")
print("功能: 开始传送 | 选择玩家 | 选择NPC | 停止传送 | 防甩飞 | 穿墙视野 | 平行环绕 | 甩飞功能 | 删除UI")
print("特性: 更小UI设计 | 修复平行环绕 | 强力甩飞机制 | NPC支持 | 统一选择界面")